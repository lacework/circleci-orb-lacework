description: >
  Execute inline scan of container image.
parameters:
  registry:
    description: Container registry where the container image has been published
    type: string
  repository:
    description: Repository name that contains the container image
    type: string
  tag:
    description: The image tag to scan
    type: string
    default: latest
  details:
    description: Show more details of the vulnerability scan results
    type: boolean
    default: false
  html:
    description: Generate a vulnerability assessment in HTML format
    type: boolean
    default: false
  digest:
    description: An image digest to scan (format sha256:1ee...1d3b)
    type: string
    default: ""
  build-id:
    description: Build ID from CircleCI
    type: string
    default: ""
  image_name:
    description: Docker image name
    type: string
    default: "chriscircleci/vuln_django"
  fixable:
    description: Display fixable vulns only
    default: false
    type: boolean
  scan_library_packages:
    description: Scan library packages from image
    type: boolean
    default: false
  save:
    description: Save results in Lacework platform
    type: boolean
    default: false
  data-directory:
    description: Directory path to store command output
    default: ""
    type: string
steps:
  - run:
      name: Execute inline scan
      command: |
        TAG_OR_DIGEST=<<parameters.tag>>
        if [[ "<<parameters.digest>>" != "" ]]; then
          # If an image digest is specified, use it instead of the tag
          TAG_OR_DIGEST=<<parameters.digest>>
        fi


        lw-scanner evaluate <<parameters.image_name>> $TAG_OR_DIGEST  \
        <<# parameters.fixable >> --fixable <</ parameters.fixable >> \
        <<# parameters.scan_library_packages >> --scan-library-packages <</ parameters.scan_library_packages >> \
        <<# parameters.save >> --save <</ parameters.save >> \
        <<# parameters.data-directory >> -d=<< parameters.data-directory >> << / parameters.data-directory >>
